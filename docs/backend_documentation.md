# Entraide National Backend Documentation

*Generated by Copilot - Last Updated: May 6, 2025*

## Table of Contents
1. [Project Overview](#project-overview)
2. [System Architecture](#system-architecture)
3. [Environment Setup](#environment-setup)
4. [API Documentation](#api-documentation)
5. [App Structure](#app-structure)
6. [Authentication](#authentication)
7. [Database Models](#database-models)
8. [Testing](#testing)
9. [Administrative Interface](#administrative-interface)

---

## Project Overview

The Entraide National platform is a comprehensive system designed to manage educational programs, centers, associations, students, and teachers. The backend is built using Django and Django REST Framework to provide a robust and scalable API for the frontend applications.

The system supports multiple user roles (Student, Teacher, Admin, Staff) with different permissions and functionalities. It also provides features for managing centers, associations, programs, exams, attendance, and schedules.

---

## System Architecture

### Technology Stack
- **Framework**: Django 5.2
- **API Framework**: Django REST Framework 3.16.0
- **Database**: PostgreSQL
- **Authentication**: JWT (JSON Web Tokens)
- **Documentation**: OpenAPI/Swagger (drf-yasg)
- **File Storage**: Cloudinary
- **Internationalization**: Supported languages include English, French, Arabic, and Amazigh

### Project Structure
The project follows a modular architecture with each functionality organized into separate Django apps:

- **accounts**: User management and authentication
- **api**: Core API functionality and utilities
- **associations**: Management of associations
- **attendance**: Student attendance tracking
- **centers**: Management of educational centers
- **exams**: Exam scheduling and grading
- **programs**: Educational program management
- **schedule**: Class scheduling
- **students**: Student management
- **teachers**: Teacher management

---

## Environment Setup

### Requirements
- Python 3.11+
- PostgreSQL
- Cloudinary account for file storage

### Configuration
The project uses environment variables for configuration, which should be stored in a `.env` file. Key configurations include:

```
SECRET_KEY=your_secret_key
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://127.0.0.1:3000

# Database settings
DB_NAME=entraide_db
DB_USER=postgres
DB_PASSWORD=your_db_password
DB_HOST=localhost
DB_PORT=5432

# Cloudinary settings
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret
```

### Installation Steps
1. Clone the repository
2. Create a virtual environment
3. Install dependencies: `pip install -r requirements.txt`
4. Configure environment variables
5. Run migrations: `python manage.py migrate`
6. Create a superuser: `python manage.py createsuperuser`
7. Run the development server: `python manage.py runserver`

---

## API Documentation

The API is documented using Swagger and ReDoc, accessible at the following endpoints:

- Swagger UI: `/swagger/`
- ReDoc: `/redoc/`
- OpenAPI Schema: `/swagger.json` or `/swagger.yaml`

### Authentication Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/token/` | POST | Obtain JWT access and refresh tokens |
| `/api/token/refresh/` | POST | Refresh JWT access token |
| `/api/accounts/users/register/` | POST | Register a new user |
| `/api/accounts/users/logout/` | POST | Logout (blacklist refresh token) |

### User Management Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/accounts/users/` | GET | List all users (paginated) |
| `/api/accounts/users/{id}/` | GET | Retrieve a specific user |
| `/api/accounts/users/{id}/` | PUT | Update a user (full update) |
| `/api/accounts/users/{id}/` | PATCH | Update a user (partial update) |
| `/api/accounts/users/{id}/` | DELETE | Delete a user |
| `/api/accounts/users/me/` | GET | Retrieve the current user's profile |
| `/api/accounts/users/me/` | PUT, PATCH | Update the current user's profile |
| `/api/accounts/users/change_password/` | POST | Change the password for the current user |

---

## App Structure

Each app follows the standard Django app structure with the following key files:

- `models.py`: Database models
- `serializers.py`: DRF serializers for API responses
- `views.py`: API views and endpoints
- `urls.py`: URL routing
- `admin.py`: Django admin interface customization
- `tests.py`: Unit tests

### Core Apps Details

#### Accounts App
The accounts app handles user management and authentication. It provides a custom User model that extends Django's AbstractUser, along with serializers and views for user registration, profile management, and authentication.

**Key Features:**
- Email-based authentication
- User roles (Student, Teacher, Admin, Staff)
- Profile management
- JWT-based authentication
- Password reset functionality

#### API App
The API app provides core functionality and utilities shared across other apps, including decorated token views for enhanced documentation.

---

## Authentication

The system uses JWT (JSON Web Token) authentication with the following configuration:

- Access tokens valid for 24 hours
- Refresh tokens valid for 7 days
- Token blacklisting for logout functionality

**Authentication Flow:**
1. User logs in with email and password
2. Server validates credentials and returns access and refresh tokens
3. Client includes access token in Authorization header for subsequent requests
4. When access token expires, client uses refresh token to obtain a new access token
5. When the user logs out, the refresh token is blacklisted

---

## Database Models

### User Model (accounts.User)
```python
class User(AbstractUser):
    email = models.EmailField(unique=True)
    role = models.CharField(max_length=50, choices=UserRole.choices, default=UserRole.STUDENT)
    profile_picture = CloudinaryField('image', blank=True, null=True)
    birth_date = models.DateField(blank=True, null=True)
    birth_city = models.CharField(max_length=100, blank=True, null=True)
    CIN_id = models.CharField(max_length=20, blank=True, null=True)
    phone_number = models.CharField(max_length=15, blank=True, null=True)
    address = models.CharField(max_length=255, blank=True, null=True)
    city = models.CharField(max_length=100, blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
```

### User Roles
```python
class UserRole(models.TextChoices):
    ADMIN = 'admin', 'Administrator'
    CENTER_SUPERVISOR = 'center_supervisor', 'Center Supervisor'
    ASSOCIATION_SUPERVISOR = 'association_supervisor', 'Association Supervisor'
    TRAINER = 'trainer', 'Trainer'
    STUDENT = 'student', 'Student'
```

---

## Testing

The project includes comprehensive tests for the accounts app, covering:

- User model tests
- Serializer tests
- API endpoint tests

To run tests:
```
python manage.py test accounts
```

Example test coverage:
- User creation and validation
- Email uniqueness validation
- User registration
- Authentication (login/logout)
- Profile management
- Password changing

---

## Administrative Interface

The project includes a custom Django admin interface for managing the application data. The admin interface has been enhanced with:

### User Management in Admin
The admin interface for the User model has been customized with:

- Organized fieldsets for better information organization
- List filters for role, active status, date joined, and city
- Search capabilities for email, username, name, and other fields
- Custom admin actions:
  - Activate users
  - Deactivate users
  - Export selected users to CSV

To access the admin interface:
1. Navigate to `/admin/`
2. Log in with superuser credentials
3. Access the various models for management

---

## Next Development Steps

1. Implement serializers and views for other apps (centers, programs, students, etc.)
2. Expand the testing suite to cover all apps
3. Implement additional API endpoints for specific business logic
4. Enhance the admin interface for other models
5. Add more comprehensive documentation for each endpoint

---

*This documentation will be updated as the project evolves.*